<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cloudplow Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        @keyframes pulse-soft {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }
        .pulse-soft {
            animation: pulse-soft 2s ease-in-out infinite;
        }
        .progress-bar {
            transition: width 0.3s ease-in-out;
        }
    </style>
</head>
<body class="bg-gray-900 text-gray-100">
    <div class="container mx-auto px-4 py-6 max-w-7xl">
        <!-- Header -->
        <header class="mb-8">
            <div class="flex justify-between items-center">
                <div>
                    <h1 class="text-4xl font-bold text-blue-400">Cloudplow Dashboard</h1>
                    <p class="text-gray-400 mt-1">Real-time upload monitoring & queue intelligence</p>
                </div>
                <div class="text-right">
                    <div id="status-indicator" class="flex items-center justify-end space-x-2">
                        <span class="w-3 h-3 rounded-full bg-gray-500"></span>
                        <span class="text-sm text-gray-400">Connecting...</span>
                    </div>
                    <div class="text-xs text-gray-500 mt-1">Auto-refresh: <span id="refresh-countdown">3</span>s</div>
                </div>
            </div>
        </header>

        <!-- Status Banner -->
        <div id="status-banner" class="hidden bg-blue-900 border border-blue-700 rounded-lg p-4 mb-6">
            <div class="flex justify-between items-center">
                <div>
                    <h2 class="text-xl font-semibold">
                        <span id="upload-status-text">Upload Active</span> - <span id="uploader-name" class="text-blue-300"></span>
                    </h2>
                    <p class="text-gray-300 text-sm mt-1">
                        Service Account: <span id="current-sa" class="font-mono text-blue-200"></span> 
                        (<span id="sa-position"></span>) | 
                        Stage: <span id="current-stage"></span>
                    </p>
                </div>
            </div>
        </div>

        <!-- No Activity Message -->
        <div id="no-activity" class="bg-gray-800 border border-gray-700 rounded-lg p-8 text-center">
            <svg class="mx-auto h-12 w-12 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 13V6a2 2 0 00-2-2H6a2 2 0 00-2 2v7m16 0v5a2 2 0 01-2 2H6a2 2 0 01-2-2v-5m16 0h-2.586a1 1 0 00-.707.293l-2.414 2.414a1 1 0 01-.707.293h-3.172a1 1 0 01-.707-.293l-2.414-2.414A1 1 0 006.586 13H4"></path>
            </svg>
            <h3 class="mt-4 text-lg font-medium text-gray-400">No Active Upload Session</h3>
            <p class="mt-2 text-sm text-gray-500">The dashboard will automatically update when uploads start</p>
        </div>

        <!-- Main Content (Hidden when no activity) -->
        <div id="main-content" class="hidden space-y-6">
            
            <!-- Current Transfers -->
            <div class="bg-gray-800 rounded-lg border border-gray-700 p-6">
                <h3 class="text-xl font-semibold mb-4 flex items-center">
                    <svg class="w-6 h-6 mr-2 text-green-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"></path>
                    </svg>
                    Current Transfers
                </h3>
                <div id="current-transfers">
                    <p class="text-gray-400 text-sm">No active transfers</p>
                </div>
                <div id="transfer-summary" class="mt-4 pt-4 border-t border-gray-700 flex justify-between text-sm">
                    <div>
                        <span class="text-gray-400">Overall Speed:</span>
                        <span id="overall-speed" class="ml-2 font-semibold text-green-400">0 MB/s</span>
                    </div>
                    <div>
                        <span class="text-gray-400">ETA:</span>
                        <span id="overall-eta" class="ml-2 font-semibold">-</span>
                    </div>
                </div>
            </div>

            <!-- Two Column Layout -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                
                <!-- Queue & Strategy -->
                <div class="bg-gray-800 rounded-lg border border-gray-700 p-6">
                    <h3 class="text-xl font-semibold mb-4 flex items-center">
                        <svg class="w-6 h-6 mr-2 text-purple-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
                        </svg>
                        Queue & Strategy
                    </h3>
                    <div id="queue-status">
                        <p class="text-gray-400 text-sm">Loading...</p>
                    </div>
                </div>

                <!-- Session Statistics -->
                <div class="bg-gray-800 rounded-lg border border-gray-700 p-6">
                    <h3 class="text-xl font-semibold mb-4 flex items-center">
                        <svg class="w-6 h-6 mr-2 text-blue-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
                        </svg>
                        Session Statistics
                    </h3>
                    <div id="session-stats">
                        <p class="text-gray-400 text-sm">Loading...</p>
                    </div>
                </div>
            </div>

            <!-- Service Accounts -->
            <div class="bg-gray-800 rounded-lg border border-gray-700 p-6">
                <h3 class="text-xl font-semibold mb-4 flex items-center">
                    <svg class="w-6 h-6 mr-2 text-yellow-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"></path>
                    </svg>
                    Service Accounts
                </h3>
                <div id="service-accounts" class="overflow-x-auto">
                    <p class="text-gray-400 text-sm">Loading...</p>
                </div>
            </div>

        </div>
    </div>

    <script>
        // Configuration
        const REFRESH_INTERVAL = 3000; // 3 seconds
        let refreshCountdown = 3;
        let countdownInterval;

        // Update countdown display
        function startCountdown() {
            if (countdownInterval) clearInterval(countdownInterval);
            refreshCountdown = 3;
            countdownInterval = setInterval(() => {
                refreshCountdown--;
                document.getElementById('refresh-countdown').textContent = refreshCountdown;
                if (refreshCountdown <= 0) refreshCountdown = 3;
            }, 1000);
        }

        // Fetch all data
        async function fetchData() {
            try {
                const [status, queueStatus, sessionStats, serviceAccounts, rcloneStats] = await Promise.all([
                    fetch('/api/status').then(r => r.json()),
                    fetch('/api/queue_status').then(r => r.json()),
                    fetch('/api/session_stats').then(r => r.json()),
                    fetch('/api/service_accounts').then(r => r.json()),
                    fetch('/api/rclone_stats').then(r => r.json())
                ]);

                updateUI(status, queueStatus, sessionStats, serviceAccounts, rcloneStats);
                updateStatusIndicator(true);
            } catch (error) {
                console.error('Error fetching data:', error);
                updateStatusIndicator(false);
            }
        }

        // Update UI with fetched data
        function updateUI(status, queueStatus, sessionStats, serviceAccounts, rcloneStats) {
            const isActive = status.active;
            
            document.getElementById('no-activity').classList.toggle('hidden', isActive);
            document.getElementById('main-content').classList.toggle('hidden', !isActive);
            document.getElementById('status-banner').classList.toggle('hidden', !isActive);

            if (isActive) {
                // Update status banner
                document.getElementById('uploader-name').textContent = status.uploader || 'Unknown';
                document.getElementById('current-sa').textContent = status.current_sa || 'Unknown';
                document.getElementById('sa-position').textContent = `${status.sa_index + 1}/${status.total_sas}`;
                document.getElementById('current-stage').textContent = `${status.stage}`;

                // Update sections
                updateCurrentTransfers(rcloneStats);
                updateQueueStatus(queueStatus);
                updateSessionStats(sessionStats);
                updateServiceAccounts(serviceAccounts);
            }
        }

        // Update current transfers section
        function updateCurrentTransfers(rcloneStats) {
            const container = document.getElementById('current-transfers');
            
            if (!rcloneStats || !rcloneStats.available || !rcloneStats.data.transferring || rcloneStats.data.transferring.length === 0) {
                container.innerHTML = '<p class="text-gray-400 text-sm">No active transfers</p>';
                document.getElementById('overall-speed').textContent = '0 MB/s';
                document.getElementById('overall-eta').textContent = '-';
                return;
            }

            const transfers = rcloneStats.data.transferring;
            const html = transfers.map(t => `
                <div class="mb-4 last:mb-0">
                    <div class="flex justify-between text-sm mb-1">
                        <span class="font-mono text-gray-300 truncate">${t.name}</span>
                        <span class="text-gray-400 ml-2">${t.percentage}%</span>
                    </div>
                    <div class="w-full bg-gray-700 rounded-full h-2 mb-1">
                        <div class="bg-gradient-to-r from-blue-500 to-green-400 h-2 rounded-full progress-bar" style="width: ${t.percentage}%"></div>
                    </div>
                    <div class="flex justify-between text-xs text-gray-400">
                        <span>${t.bytes_human} / ${t.size_human}</span>
                        <span>${t.speed_human} • ETA: ${t.eta_human}</span>
                    </div>
                </div>
            `).join('');
            
            container.innerHTML = html;
            document.getElementById('overall-speed').textContent = rcloneStats.data.speed_human;
            document.getElementById('overall-eta').textContent = rcloneStats.data.eta_human;
        }

        // Update queue status section
        function updateQueueStatus(queueStatus) {
            const container = document.getElementById('queue-status');
            
            if (!queueStatus || !queueStatus.available) {
                container.innerHTML = '<p class="text-gray-400 text-sm">No queue data available</p>';
                return;
            }

            const data = queueStatus.data;
            const params = data.stage_params || {};
            const stats = data.queue_stats || {};
            
            // Checking progress
            const totalChecks = stats.totalChecks || 0;
            const checks = stats.checks || 0;
            const checkPercent = totalChecks > 0 ? (checks / totalChecks * 100) : 100;
            const isChecking = stats.checking_count > 0;
            
            const html = `
                <div class="space-y-4">
                    <!-- Stage Parameters -->
                    <div class="bg-gray-700 rounded p-3 text-sm">
                        <div class="text-xs text-gray-400 uppercase tracking-wide mb-2">Current Stage Parameters</div>
                        <div class="grid grid-cols-2 gap-2">
                            <div><span class="text-gray-400">Strategy:</span> <span class="text-blue-300">${params.strategy}</span></div>
                            <div><span class="text-gray-400">Max Transfer:</span> <span class="font-mono">${params.max_transfer}</span></div>
                            <div><span class="text-gray-400">Max Size:</span> <span class="font-mono">${params.max_size}</span></div>
                            <div><span class="text-gray-400">Transfers:</span> <span class="font-mono">${params.transfers}</span></div>
                            <div><span class="text-gray-400">Order By:</span> <span class="font-mono text-xs">${params.order_by || 'None'}</span></div>
                            <div><span class="text-gray-400">Backlog:</span> <span class="font-mono">${params.max_backlog || 'Default'}</span></div>
                        </div>
                    </div>
                    
                    <!-- Queue Stats -->
                    <div>
                        <div class="flex justify-between text-sm mb-1">
                            <span class="text-gray-400">Scanning Progress</span>
                            <span class="font-mono text-xs">${checks.toLocaleString()} / ${totalChecks.toLocaleString()}</span>
                        </div>
                        <div class="w-full bg-gray-700 rounded-full h-2 mb-1">
                            <div class="bg-purple-500 h-2 rounded-full progress-bar" style="width: ${checkPercent}%"></div>
                        </div>
                        <div class="text-xs text-gray-400 mb-3">${isChecking ? 'Checking in progress...' : 'Scan complete'}</div>
                        
                        ${stats.checking && stats.checking.length > 0 ? `
                            <div class="text-xs text-gray-400 mb-2">Currently Checking (${stats.checking_count}):</div>
                            <div class="bg-gray-900 rounded p-2 font-mono text-xs text-gray-500 overflow-hidden">
                                ${stats.checking.map(f => `<div class="truncate">• ${f}</div>`).join('')}
                            </div>
                        ` : ''}
                        
                        <div class="grid grid-cols-2 gap-3 mt-3 pt-3 border-t border-gray-700 text-sm">
                            <div>
                                <span class="text-gray-400 block text-xs">Transfer Queue</span>
                                <span class="font-semibold text-lg">${(stats.totalTransfers || 0).toLocaleString()}</span>
                            </div>
                            <div>
                                <span class="text-gray-400 block text-xs">Active Transfers</span>
                                <span class="font-semibold text-lg text-green-400">${stats.transferring_count || 0}</span>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            container.innerHTML = html;
        }

        // Update session statistics
        function updateSessionStats(sessionStats) {
            const container = document.getElementById('session-stats');
            
            if (!sessionStats || !sessionStats.available) {
                container.innerHTML = '<p class="text-gray-400 text-sm">No session data available</p>';
                return;
            }

            const data = sessionStats.data;
            
            const html = `
                <div class="space-y-4">
                    <div>
                        <div class="flex justify-between text-sm mb-1">
                            <span class="text-gray-400">Files Progress</span>
                            <span class="font-semibold">${data.transferred_files.toLocaleString()} / ${data.total_files.toLocaleString()}</span>
                        </div>
                        <div class="w-full bg-gray-700 rounded-full h-3">
                            <div class="bg-gradient-to-r from-blue-500 to-green-400 h-3 rounded-full progress-bar" style="width: ${data.file_percentage}%"></div>
                        </div>
                        <div class="text-xs text-gray-400 mt-1">${data.file_percentage}% complete</div>
                    </div>

                    <div>
                        <div class="flex justify-between text-sm mb-1">
                            <span class="text-gray-400">Data Progress</span>
                            <span class="font-semibold">${data.transferred_bytes_human} / ${data.total_bytes_human}</span>
                        </div>
                        <div class="w-full bg-gray-700 rounded-full h-3">
                            <div class="bg-gradient-to-r from-purple-500 to-pink-400 h-3 rounded-full progress-bar" style="width: ${data.byte_percentage}%"></div>
                        </div>
                        <div class="text-xs text-gray-400 mt-1">${data.byte_percentage}% complete</div>
                    </div>

                    <div class="grid grid-cols-2 gap-3 pt-3 border-t border-gray-700">
                        <div class="bg-gray-700 p-3 rounded">
                            <div class="text-xs text-gray-400">Duration</div>
                            <div class="text-lg font-semibold">${data.duration_human}</div>
                        </div>
                        <div class="bg-gray-700 p-3 rounded">
                            <div class="text-xs text-gray-400">Avg Speed</div>
                            <div class="text-lg font-semibold">${data.avg_speed_human}</div>
                        </div>
                        <div class="bg-gray-700 p-3 rounded">
                            <div class="text-xs text-gray-400">Remaining</div>
                            <div class="text-lg font-semibold">${data.remaining_bytes_human}</div>
                        </div>
                        <div class="bg-gray-700 p-3 rounded">
                            <div class="text-xs text-gray-400">ETA</div>
                            <div class="text-lg font-semibold">${data.eta_human}</div>
                        </div>
                    </div>

                    <div class="text-xs text-gray-400 pt-2 border-t border-gray-700">
                        Session started: ${data.session_start} • 
                        SAs used: ${data.sas_used.length}
                    </div>
                </div>
            `;
            
            container.innerHTML = html;
        }

        // Update service accounts table
        function updateServiceAccounts(accounts) {
            const container = document.getElementById('service-accounts');
            
            if (!accounts || accounts.length === 0) {
                container.innerHTML = '<p class="text-gray-400 text-sm">No service account data available</p>';
                return;
            }

            const statusColors = {
                'active': 'bg-green-500',
                'complete': 'bg-blue-500',
                'ready': 'bg-gray-500'
            };

            const statusLabels = {
                'active': 'Active',
                'complete': 'Complete',
                'ready': 'Ready'
            };

            const html = `
                <table class="min-w-full divide-y divide-gray-700">
                    <thead>
                        <tr class="text-left text-xs text-gray-400 uppercase">
                            <th class="py-3 px-4">SA File</th>
                            <th class="py-3 px-4">Status</th>
                            <th class="py-3 px-4">Usage</th>
                            <th class="py-3 px-4">Quota</th>
                            <th class="py-3 px-4">Reset Time</th>
                        </tr>
                    </thead>
                    <tbody class="divide-y divide-gray-700">
                        ${accounts.map(sa => `
                            <tr class="text-sm">
                                <td class="py-3 px-4 font-mono text-gray-300">${sa.sa_file}</td>
                                <td class="py-3 px-4">
                                    <span class="inline-flex items-center px-2 py-1 rounded text-xs font-medium ${statusColors[sa.status]} bg-opacity-20">
                                        <span class="w-2 h-2 mr-1.5 rounded-full ${statusColors[sa.status]}"></span>
                                        ${statusLabels[sa.status]}
                                    </span>
                                </td>
                                <td class="py-3 px-4">
                                    <div class="w-32">
                                        <div class="w-full bg-gray-700 rounded-full h-2">
                                            <div class="h-2 rounded-full progress-bar ${sa.percentage > 90 ? 'bg-red-500' : sa.percentage > 70 ? 'bg-yellow-500' : 'bg-green-500'}" style="width: ${sa.percentage}%"></div>
                                        </div>
                                        <div class="text-xs text-gray-400 mt-1">${sa.percentage}%</div>
                                    </div>
                                </td>
                                <td class="py-3 px-4 font-mono">${sa.used_gb} / ${sa.quota_gb} GB</td>
                                <td class="py-3 px-4 text-gray-400">${sa.reset_in}</td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;
            
            container.innerHTML = html;
        }

        // Update status indicator
        function updateStatusIndicator(isConnected) {
            const indicator = document.getElementById('status-indicator');
            
            if (isConnected) {
                indicator.innerHTML = `
                    <span class="w-3 h-3 rounded-full bg-green-500 pulse-soft"></span>
                    <span class="text-sm text-green-400">Connected</span>
                `;
            } else {
                indicator.innerHTML = `
                    <span class="w-3 h-3 rounded-full bg-red-500"></span>
                    <span class="text-sm text-red-400">Disconnected</span>
                `;
            }
        }

        // Initialize
        startCountdown();
        fetchData();
        setInterval(fetchData, REFRESH_INTERVAL);
    </script>
</body>
</html>

